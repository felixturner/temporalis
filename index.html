<!doctype html>
<html lang="en-US">
	<head>
		<meta charset="UTF-8">
		<title>Temporalis</title>

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

		<script src="libs/modernizr.js"></script>
		<script src="SlitScan.js"></script>
		<script src="libs/dat.gui.js"></script>
		<script src="libs/stats.min.js"></script>

		<script src="libs/three.min.js"></script>
		
		<style type="text/css">

			body, html {
				background: black;
				margin: 0;
			}

			canvas#slit-scan {
				position: absolute;
				top: 0;
				left: 0;
				-o-transform: scaleX(-1);
				-ms-transform: scaleX(-1);
				-moz-transform: scaleX(-1);
				-webkit-transform: scaleX(-1);
				transform: scaleX(-1);
			}

			#buffer {
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
				display: none;
			}

			.dg.main {
				margin-right: 0;
			}

			a {
				position: absolute;
				width: 100%;
				bottom: 10px;
				text-align: center;
				color: white;
				text-decoration: none;
				font-family: Helvetica, Arial, sans;
				z-index: 10;
				text-shadow: 0 0 2px black;
			}

			a:hover {
				color: red;

			}

			html:-moz-full-screen .hide-fullscreen{
				display:none !important;
			}
			 
			html:-webkit-full-screen .hide-fullscreen{
				display:none !important;
			}
			 
			html:fullscreen .hide-fullscreen {
				display:none !important;
			}
			
		</style>

		<!-- ShaderMaterial Source -->

		<script id="vertexShader" type="x-shader/x-vertex">
			varying vec2 vUv;
			void main()
			{
				vUv = uv;
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}

		</script>

		<script id="fragmentShader" type="x-shader/x-fragment">

			uniform sampler2D texture1;
			uniform sampler2D texture2;
			uniform float slices;
			uniform int smoothing; //0 = false, 1 = true
			uniform int direction; //0 = vert, 1 = horiz
			varying vec2 vUv;

			void main() {

				//horizontal mirror
				vec2 uv = vUv;
				uv.x = 1.0 - uv.x;

				if (smoothing == 1){

					//create gradient stripes
					float mixAmt;
					if (direction == 0){
						mixAmt = fract(uv.y * slices);
					}else{
						mixAmt = fract((1.0 - uv.x) * slices);
					}
					
					//mix frames based on gradient stripes
					vec4 texel1 = texture2D( texture1, uv );
					vec4 texel2 = texture2D( texture2, uv );
					gl_FragColor = mix( texel1, texel2, mixAmt);

					//debug
					//vec4 mixCol = vec4(mixAmt,0,0,1.0);
					//gl_FragColor = mix( texel1, mixCol, 0.5);


				} else{
					//passthru
					gl_FragColor = texture2D(texture1, uv);
				}
			}

		</script>

		<script>

			var ss;

			window.onload = function () {

				ss = new SlitScan();
				ss.init();

				var gui = new dat.GUI();
				gui.add(ss, 'slices', 10, 400).onChange(ss.updateUniforms);
				gui.add(ss, 'mode', ['vertical', 'horizontal']).onChange(ss.updateUniforms);
				gui.add(ss, 'smoothing',true ).onChange(ss.updateUniforms);
				gui.add(ss, 'throttle',false);
				gui.add({
					fullscreen: function(){
						var el = document.documentElement;
						var rfs = el.requestFullScreen || el.webkitRequestFullScreen || el.mozRequestFullScreen;
						rfs.call(el);

					}
				}, "fullscreen");
				gui.add({
					save: function(){

						ss.saveImage();

						//window.open(document.querySelector('#slit-scan').toDataURL(), '_blank');

						}
					}, "save");

			};

			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-24253469-1']);
			_gaq.push(['_trackPageview']);

			(function () {
				var ga = document.createElement('script');
				ga.type = 'text/javascript';
				ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0];
				s.parentNode.insertBefore(ga, s);
			})();


		</script>
	</head>

	<body>
		<a class="hide-fullscreen" href="https://github.com/positlabs/temporalis" target="_blank">Fork on GitHub</a>
	</body>
	
</html>